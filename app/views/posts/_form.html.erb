<%= form_with model: post, local: true, html: { class: "space-y-6" }, data: { controller: "product-search" } do |f| %>
  <%= render "shared/error_messages", resource: post %>

  <div class="lg:grid lg:grid-cols-5 lg:gap-8 space-y-6 lg:space-y-0">
    <!-- 左側: 基本情報 (PC時2/5幅) -->
    <div class="lg:col-span-2 space-y-5">
      <div>
        <%= f.label :title, "商品名", class: "block text-sm font-medium text-orange-700 mb-2" %>
        <div class="relative">
          <%= f.text_field :title,
                          class: "w-full pl-4 pr-4 py-3 border border-orange-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white transition duration-200" %>
        </div>
      </div>

      <!-- スマホ時のみ表示: 商品名直下の楽天検索 -->
      <div class="lg:hidden">
        <%= render 'rakuten_search' %>
      </div>
      
      <div>
        <%= f.label :description, "おすすめポイント", class: "block text-sm font-medium text-orange-700 mb-2" %>
        <div class="relative">
          <%= f.text_area :description, rows: 4,
                          class: "w-full pl-4 pr-4 py-3 border border-orange-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white transition duration-200 resize-none" %>
        </div>
      </div>

      <div>
        <%= f.label :link, "通販リンク（任意）", class: "block text-sm font-medium text-orange-700 mb-2" %>
        <div class="relative">
          <%= f.url_field :link,
                          placeholder: "https://example.com/product",
                          class: "w-full pl-4 pr-4 py-3 border border-orange-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white transition duration-200" %>
        </div>
      </div>

      <div>
        <%= f.label :image_url, "画像URL（任意）", class: "block text-sm font-medium text-orange-700 mb-2" %>
        <div class="relative">
          <%= f.url_field :image_url,
                          placeholder: "https://example.com/image.jpg",
                          class: "w-full pl-4 pr-4 py-3 border border-orange-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white transition duration-200",
                          data: { 
                            controller: "image-preview",
                            action: "input->image-preview#updatePreview"
                          } %>
        </div>
      </div>

      <div data-controller="image-preview">
        <%= f.label :image, "画像をアップロード（任意）", class: "block text-sm font-medium text-orange-700 mb-2" %>

        <!-- 編集ページのみ: 現在の画像表示 -->
        <% if post.persisted? && post.image.attached? %>
          <div class="mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200">
            <p class="text-sm text-orange-700 mb-2">現在の画像:</p>
            <div class="flex items-center space-x-3">
              <%= image_tag post.thumbnail_image,
                            class: "w-16 h-16 object-cover rounded-lg border border-orange-200",
                            alt: "現在の画像" %>
              <div>
                <p class="text-sm font-medium text-orange-600"><%= post.image.filename %></p>
                <p class="text-xs text-orange-500">
                  <%= number_to_human_size(post.image.byte_size) %> |
                  <%= post.image.created_at.strftime("%Y/%m/%d") %>
                </p>
              </div>
            </div>
            <p class="text-xs text-orange-500 mt-2">
              💡 新しい画像を選択すると、この画像が置き換えられます
            </p>
          </div>
        <% end %>

        <div class="relative">
          <%= f.file_field :image,
                           class: "w-full pl-4 pr-4 py-3 border border-orange-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white transition duration-200",
                           accept: "image/*",
                           data: {
                             "image-preview-target": "input",
                             "action": "change->image-preview#preview"
                           } %>
        </div>
        <!-- 画像プレビュー表示 -->
        <div class="mt-3">
          <img data-image-preview-target="preview"
               class="hidden max-w-xs rounded-lg border border-orange-200 shadow-sm"
               alt="画像プレビュー">
        </div>
        <!-- ファイル制限の案内 -->
        <div class="mt-2">
          <p class="text-xs text-gray-500">
            JPEG、PNG、GIF、WebP形式で10MB以下のファイルをご利用ください
          </p>
        </div>
      </div>
    </div>

    <!-- PC時のみ表示: 右側の拡大楽天検索 (PC時3/5幅) -->
    <div class="hidden lg:block lg:col-span-3">
      <%= render 'rakuten_search', desktop: true %>
    </div>
  </div>

  <!-- フォーム送信ボタン -->
  <div class="mt-8 text-center">
    <%= f.submit post.persisted? ? "更新する" : "投稿する", 
        class: "w-full lg:w-auto bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-8 rounded-lg text-lg transition duration-200 shadow-lg hover:shadow-xl" %>
  </div>
<% end %>