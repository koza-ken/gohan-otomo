<%= form_with model: post, local: true, html: { class: "space-y-6" }, data: { controller: "product-search unified-preview" } do |f| %>
  <%= render "shared/error_messages", resource: post %>

  <div class="lg:grid lg:grid-cols-5 lg:gap-8 space-y-6 lg:space-y-0">
    <!-- 左側: 基本情報 (PC時2/5幅) -->
    <div class="lg:col-span-2 space-y-5">
      <div>
        <%= f.label :title, "商品名から検索", class: "block text-sm font-medium text-orange-700 mb-2" %>
        <div class="flex space-x-2">
          <%= f.text_field :title,
                          placeholder: "お好みの商品名を入力",
                          class: "flex-1 pl-4 pr-4 py-3 border border-orange-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white transition duration-200" %>
          <button type="button"
                  data-action="click->product-search#searchByProductName"
                  class="px-4 py-3 bg-orange-500 hover:bg-orange-600 text-white text-sm font-medium rounded-lg transition duration-200 whitespace-nowrap">
            検索
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-1">商品名から検索できます</p>
      </div>

      <div>
        <%= label_tag :rakuten_url, "楽天市場URLから検索", class: "block text-sm font-medium text-orange-700 mb-2" %>
        <div class="flex space-x-2">
          <%= text_field_tag :rakuten_url, "",
                            placeholder: "例：https://item.rakuten.co.jp/...",
                            class: "flex-1 pl-4 pr-4 py-3 border border-orange-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white transition duration-200" %>
          <button type="button"
                  data-action="click->product-search#searchByUrl"
                  class="px-4 py-3 bg-orange-500 hover:bg-orange-600 text-white text-sm font-medium rounded-lg transition duration-200 whitespace-nowrap">
            検索
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-1">楽天市場の商品URLを貼り付けると検索できます
        </p>
      </div>

      <!-- スマホ時のみ表示: 楽天検索結果表示エリア -->
      <div class="lg:hidden">
        <%= render 'rakuten_search' %>
      </div>

      <div>
        <%= f.label :description, "おすすめポイント（200文字以内）", class: "block text-sm font-medium text-orange-700 mb-2" %>
        <div class="relative">
          <%= f.text_area :description, rows: 4,
                          class: "w-full pl-4 pr-4 py-3 border border-orange-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white transition duration-200 resize-none" %>
        </div>
      </div>


      <!-- 画像選択方法 -->
      <div class="mb-6">
        <h4 class="text-sm font-medium text-orange-700 mb-3">画像の選択方法</h4>

        <div class="space-y-3">
          <!-- URL画像選択（デフォルト） -->
          <label class="flex items-start space-x-3 p-3 border border-orange-200 rounded-lg hover:bg-orange-50 cursor-pointer transition duration-200">
            <%= f.radio_button :image_source, "url",
                               checked: true,
                               class: "mt-1 text-orange-500 focus:ring-orange-500",
                               data: {
                                 "unified-preview-target": "imageSourceRadio",
                                 "action": "change->unified-preview#switchImageSource"
                               } %>
            <div class="flex-1">
              <div class="font-medium text-orange-700">商品画像を検索</div>
              <div class="text-sm text-gray-600 mt-1">楽天市場から商品名またはURLで画像を取得します</div>
            </div>
          </label>

          <!-- ファイル画像選択 -->
          <label class="flex items-start space-x-3 p-3 border border-orange-200 rounded-lg hover:bg-orange-50 cursor-pointer transition duration-200">
            <%= f.radio_button :image_source, "file",
                               class: "mt-1 text-orange-500 focus:ring-orange-500",
                               data: {
                                 "unified-preview-target": "imageSourceRadio",
                                 "action": "change->unified-preview#switchImageSource"
                               } %>
            <div class="flex-1">
              <div class="font-medium text-orange-700">画像アップロード</div>
              <div class="text-sm text-gray-600 mt-1">自分のデバイスから画像をアップロードします</div>
            </div>
          </label>
        </div>
      </div>

      <!-- 楽天API専用画像URL（手動入力制限） -->
      <div data-unified-preview-target="urlSection" class="hidden mb-6">
        <%= f.label :image_url, "画像URL（自動入力）", class: "block text-sm font-medium text-orange-700 mb-2" %>
        <div class="relative">
          <%= f.url_field :image_url,
                          readonly: true,
                          placeholder: "楽天商品検索で画像を選択してください",
                          class: "w-full pl-4 pr-4 py-3 border border-orange-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-gray-50 transition duration-200",
                          data: {
                            "unified-preview-target": "urlInput",
                            action: "input->unified-preview#updateUrlPreview"
                          } %>
        </div>
        <div class="mt-2">
          <p class="text-xs text-gray-500">
            楽天商品検索で選択すると自動で入力されます（手動入力不可）
          </p>
        </div>
      </div>

      <!-- ファイル入力フィールド -->
      <div data-unified-preview-target="fileSection" class="hidden mb-6">
        <%= f.label :image, "画像アップロード", class: "block text-sm font-medium text-orange-700 mb-2" %>

        <!-- 編集ページのみ: 現在の画像表示 -->
        <% if post.persisted? && post.image.attached? %>
          <div class="mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200">
            <p class="text-sm text-orange-700 mb-2">現在の画像:</p>
            <div class="flex items-center space-x-3">
              <%= image_tag post.thumbnail_image_webp,
                            class: "w-16 h-16 object-cover rounded-lg border border-orange-200",
                            alt: "現在の画像" %>
              <div>
                <p class="text-sm font-medium text-orange-600"><%= post.image.filename %></p>
                <p class="text-xs text-orange-500">
                  <%= number_to_human_size(post.image.byte_size) %> |
                  <%= post.image.created_at.strftime("%Y/%m/%d") %>
                </p>
              </div>
            </div>
            <p class="text-xs text-orange-500 mt-2">
              新しい画像を選択すると、この画像が置き換えられます
            </p>
          </div>
        <% end %>

        <!-- カスタムファイル選択UI -->
        <div class="relative">
          <label class="flex items-center justify-center w-full p-3 border border-orange-200 rounded-lg hover:bg-orange-50 cursor-pointer transition duration-200 bg-white">
            <%= f.file_field :image,
                             class: "sr-only",
                             accept: "image/*",
                             data: {
                               "unified-preview-target": "fileInput",
                               "action": "change->unified-preview#updateFilePreview"
                             } %>
            <div class="flex items-center space-x-2">
              <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
              </svg>
              <span data-unified-preview-target="fileLabel" class="text-orange-600 font-medium">ファイルを選択</span>
            </div>
          </label>
        </div>

        <!-- ファイル制限の案内 -->
        <div class="mt-1">
          <p class="text-xs text-gray-500">
            10MB以下のファイルをご利用ください
          </p>
        </div>
      </div>

      <!-- 画像プレビューエリア -->
      <div class="mb-6">
        <div class="flex items-center mb-3">
          <h4 class="text-sm font-medium text-orange-700">画像プレビュー</h4>
          <button type="button"
                  class="text-xs text-red-600 hover:text-red-800 underline hidden pl-8"
                  data-unified-preview-target="clearButton"
                  data-action="click->unified-preview#clearActiveImage">削除</button>
        </div>

        <!-- 選択された画像のプレビュー -->
        <div data-unified-preview-target="activePreviewArea" class="hidden p-4 bg-orange-50 rounded-lg border border-orange-200">
          <div class="flex items-start space-x-3">
            <img data-unified-preview-target="activePreviewImage"
                 class="max-w-xs max-h-48 rounded-lg border border-orange-200 shadow-sm object-cover"
                 alt="選択中の画像プレビュー">
            <div class="flex-1 min-w-0">
              <p data-unified-preview-target="activeImageInfo" class="text-xs text-gray-600"></p>
            </div>
          </div>
        </div>

        <!-- プレースホルダー -->
        <div data-unified-preview-target="placeholder" class="p-4 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200 text-center">
          <p class="text-sm text-gray-500">プレビュー</p>
        </div>
      </div>

      <div>
        <%= f.label :link, "商品リンク", class: "block text-sm font-medium text-orange-700 mb-2" %>
        <div class="relative">
          <%= f.url_field :link,
                          placeholder: "https://example.com/product",
                          class: "w-full pl-4 pr-4 py-3 border border-orange-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white transition duration-200" %>
        </div>
         <div class="mt-2">
          <p class="text-xs text-gray-500">
            投稿に商品のリンクが追加されます
          </p>
        </div>
      </div>
    </div>

    <!-- PC時のみ表示: 右側の拡大楽天検索 (PC時3/5幅) -->
    <div class="hidden lg:block lg:col-span-3">
      <%= render 'rakuten_search', desktop: true %>
    </div>
  </div>

  <!-- フォーム送信ボタン -->
  <div class="mt-8 text-center">
    <%= f.submit post.persisted? ? "更新する" : "投稿する",
        class: "w-full lg:w-auto bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-8 rounded-lg text-lg transition duration-200 shadow-lg hover:shadow-xl" %>
  </div>
<% end %>
